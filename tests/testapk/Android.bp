package {
    default_applicable_licenses: ["Android-Apache-2.0"],
}

android_test {
    name: "MicrodroidTestApp",
    test_suites: [
        "cts",
        "general-tests",
    ],
    srcs: ["src/java/**/*.java"],
    static_libs: [
        "MicrodroidDeviceTestHelper",
        "androidx.test.runner",
        "androidx.test.ext.junit",
        "authfs_test_apk_assets",
        "cbor-java",
        "com.android.microdroid.testservice-java",
        "truth-prebuilt",
        "compatibility-common-util-devicesidelib",
    ],
    libs: ["android.system.virtualmachine"],
    jni_libs: [
        "MicrodroidTestNativeLib",
        "MicrodroidTestNativeCrashLib",
    ],
    platform_apis: true,
    use_embedded_native_libs: true,
    // We only support 64-bit ABI, but CTS demands all APKs to be multi-ABI.
    compile_multilib: "both",
    min_sdk_version: "33",
}

cc_library_shared {
    name: "MicrodroidTestNativeLib",
    srcs: ["src/native/testbinary.cpp"],
    stl: "libc++_static",
    shared_libs: [
        "libbinder_ndk",
        "MicrodroidTestNativeLibSub",
        "libvm_payload",
    ],
    static_libs: [
        "com.android.microdroid.testservice-ndk",
        "libbase",
        "libfsverity_digests_proto_cc",
        "liblog",
        "libprotobuf-cpp-lite-ndk",
    ],
}

cc_library_shared {
    name: "MicrodroidTestNativeCrashLib",
    header_libs: ["vm_payload_headers"],
    srcs: ["src/native/crashbinary.cpp"],
    stl: "libc++_static",
}

cc_library_shared {
    name: "MicrodroidTestNativeLibSub",
    srcs: ["src/native/testlib.cpp"],
    stl: "libc++_static",
}
